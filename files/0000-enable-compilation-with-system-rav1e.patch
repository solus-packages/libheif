From 2d7b2a93083dc5bb22f6bd971fd054e9cec94a35 Mon Sep 17 00:00:00 2001
From: Martin Reboredo <yakoyoku@gmail.com>
Date: Mon, 14 Sep 2020 13:50:11 -0300
Subject: [PATCH] Enable compilation with system rav1e.

Signed-off-by: Martin Reboredo <yakoyoku@gmail.com>
---
 configure.ac                  | 18 +++++++++---------
 libheif/Makefile.am           | 10 +++++-----
 libheif/heif_encoder_rav1e.cc |  2 +-
 3 files changed, 15 insertions(+), 15 deletions(-)

diff --git a/configure.ac b/configure.ac
index 8469ea2..12c8a44 100644
--- a/configure.ac
+++ b/configure.ac
@@ -189,14 +189,14 @@ if eval "test x$have_gdkpixbuf2 = xyes"; then
     AC_SUBST([gdk_pixbuf_cache_file])
 fi
 
-AC_ARG_ENABLE([local_rav1e], AS_HELP_STRING([--enable-local-rav1e],
-    [Enable compiling with local rav1e encoder.]), [], [enable_local_rav1e=no])
-if eval "test x$enable_local_rav1e != xno"; then
-    AC_MSG_NOTICE([Enable compiling with local rav1e])
-    AC_DEFINE([HAVE_RAV1E], [1], [Whether rav1e plugin has been enabled.])
-fi
-AM_CONDITIONAL([ENABLE_LOCAL_RAV1E], [test "x$enable_local_rav1e" != "xno"])
-AC_SUBST(ENABLE_LOCAL_RAV1E)
+PKG_CHECK_MODULES([rav1e], [rav1e], [
+    AC_DEFINE([HAVE_RAV1E], [1], [Whether rav1e was found.])
+    AC_SUBST(rav1e_CFLAGS)
+    AC_SUBST(rav1e_LIBS)
+    have_rav1e="yes"
+], [have_rav1e="no"])
+AM_CONDITIONAL([HAVE_RAV1E], [test "x$have_rav1e" != "xno"])
+AC_SUBST(HAVE_RAV1E)
 
 
 AC_ARG_ENABLE([libfuzzer], AS_HELP_STRING([--enable-libfuzzer],
@@ -236,7 +236,7 @@ AC_MSG_NOTICE([Multithreading: $enable_multithreading])
 AC_MSG_NOTICE([Symbol visibility: $enable_visibility])
 AC_MSG_NOTICE([libaom decoder: $have_aom])
 AC_MSG_NOTICE([libaom encoder: $have_aom])
-AC_MSG_NOTICE([rav1e encoder: $enable_local_rav1e])
+AC_MSG_NOTICE([rav1e encoder: $have_rav1e])
 AC_MSG_NOTICE([libde265 decoder: $have_libde265])
 AC_MSG_NOTICE([libx265 encoder: $have_x265])
 AC_MSG_NOTICE([JPEG output: $have_libjpeg])
diff --git a/libheif/Makefile.am b/libheif/Makefile.am
index a2b91ea..2d8a0bf 100644
--- a/libheif/Makefile.am
+++ b/libheif/Makefile.am
@@ -21,8 +21,8 @@ if HAVE_X265
 ADDITIONAL_LIBS += $(x265_LIBS)
 endif
 
-if ENABLE_LOCAL_RAV1E
-ADDITIONAL_LIBS += ../third-party/rav1e/target/release/librav1e.a
+if HAVE_RAV1E
+ADDITIONAL_LIBS += $(rav1e_LIBS)
 endif
 
 libheif_la_CPPFLAGS =
@@ -37,8 +37,8 @@ libheif_la_CXXFLAGS = \
   -DLIBHEIF_EXPORTS -I$(top_srcdir)
 libheif_la_LIBADD = $(ADDITIONAL_LIBS)
 
-if ENABLE_LOCAL_RAV1E
-libheif_la_CXXFLAGS += -I../third-party/rav1e/target/release/include
+if HAVE_RAV1E
+libheif_la_CXXFLAGS += $(rav1e_LIBS)
 endif
 
 libheif_la_LDFLAGS = -version-info $(LIBHEIF_CURRENT):$(LIBHEIF_REVISION):$(LIBHEIF_AGE)
@@ -91,7 +91,7 @@ libheif_la_SOURCES += \
   heif_decoder_libde265.h
 endif
 
-if ENABLE_LOCAL_RAV1E
+if HAVE_RAV1E
 libheif_la_SOURCES += \
   heif_encoder_rav1e.cc \
   heif_encoder_rav1e.h
diff --git a/libheif/heif_encoder_rav1e.cc b/libheif/heif_encoder_rav1e.cc
index 69ad6ab..aa419c7 100644
--- a/libheif/heif_encoder_rav1e.cc
+++ b/libheif/heif_encoder_rav1e.cc
@@ -37,7 +37,7 @@
 
 #include <iostream>  // TODO: remove me
 
-#include "rav1e/rav1e.h"
+#include <rav1e/rav1e.h>
 
 
 struct encoder_struct_rav1e
-- 
2.27.0

