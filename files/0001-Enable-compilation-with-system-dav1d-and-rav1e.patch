From 886516751918f65735ffe025127d6849288b87d8 Mon Sep 17 00:00:00 2001
From: Martin Reboredo <yakoyoku@gmail.com>
Date: Wed, 7 Oct 2020 19:54:07 -0300
Subject: [PATCH] Enable compilation with system dav1d and rav1e.

Signed-off-by: Martin Reboredo <yakoyoku@gmail.com>
---
 configure.ac                  | 37 +++++++++++++++++------------------
 libheif/Makefile.am           | 21 +++++++-------------
 libheif/heif_encoder_rav1e.cc |  2 +-
 3 files changed, 26 insertions(+), 34 deletions(-)

diff --git a/configure.ac b/configure.ac
index 5d75a8a..8aaab9a 100644
--- a/configure.ac
+++ b/configure.ac
@@ -195,25 +195,24 @@ if eval "test x$have_gdkpixbuf2 = xyes"; then
     AC_SUBST([gdk_pixbuf_cache_file])
 fi
 
-AC_ARG_ENABLE([local_rav1e], AS_HELP_STRING([--enable-local-rav1e],
-    [Enable compiling with local rav1e encoder.]), [], [enable_local_rav1e=no])
-if eval "test x$enable_local_rav1e != xno"; then
-    AC_MSG_NOTICE([Enable compiling with local rav1e])
-    AC_DEFINE([HAVE_RAV1E], [1], [Whether rav1e plugin has been enabled.])
+PKG_CHECK_MODULES([rav1e], [rav1e], [
+    AC_DEFINE([HAVE_RAV1E], [1], [Whether rav1e was found.])
+    AC_SUBST(rav1e_CFLAGS)
+    AC_SUBST(rav1e_LIBS)
+    have_rav1e="yes"
     have_avif_encoder="yes"
-fi
-AM_CONDITIONAL([ENABLE_LOCAL_RAV1E], [test "x$enable_local_rav1e" != "xno"])
-AC_SUBST(ENABLE_LOCAL_RAV1E)
-
-AC_ARG_ENABLE([local_dav1d], AS_HELP_STRING([--enable-local-dav1d],
-    [Enable compiling with local dav1d decoder.]), [], [enable_local_dav1d=no])
-if eval "test x$enable_local_dav1d != xno"; then
-    AC_MSG_NOTICE([Enable compiling with local dav1d])
-    AC_DEFINE([HAVE_DAV1D], [1], [Whether dav1d plugin has been enabled.])
+], [have_rav1e="no"])
+AM_CONDITIONAL([HAVE_RAV1E], [test "x$have_rav1e" != "xno"])
+AC_SUBST(HAVE_RAV1E)
+
+PKG_CHECK_MODULES([dav1d], [dav1d], [
+    AC_DEFINE([HAVE_DAV1D], [1], [Whether dav1d was found.])
+    AC_SUBST(dav1d_CFLAGS)
+    AC_SUBST(dav1d_LIBS)
     have_avif_encoder="yes"
-fi
-AM_CONDITIONAL([ENABLE_LOCAL_DAV1D], [test "x$enable_local_dav1d" != "xno"])
-AC_SUBST(ENABLE_LOCAL_DAV1D)
+    have_dav1d="yes"
+], [have_dav1d="no"])
+AM_CONDITIONAL([HAVE_DAV1D], [test "x$have_dav1d" = "xyes"])
 
 AC_SUBST(have_avif_decoder)
 AC_SUBST(have_avif_encoder)
@@ -255,8 +254,8 @@ AC_MSG_NOTICE([Multithreading: $enable_multithreading])
 AC_MSG_NOTICE([Symbol visibility: $enable_visibility])
 AC_MSG_NOTICE([libaom decoder: $have_aom])
 AC_MSG_NOTICE([libaom encoder: $have_aom])
-AC_MSG_NOTICE([rav1e encoder: $enable_local_rav1e])
-AC_MSG_NOTICE([dav1d decoder: $enable_local_dav1d])
+AC_MSG_NOTICE([rav1e encoder: $have_rav1e])
+AC_MSG_NOTICE([dav1d decoder: $have_dav1d])
 AC_MSG_NOTICE([libde265 decoder: $have_libde265])
 AC_MSG_NOTICE([libx265 encoder: $have_x265])
 AC_MSG_NOTICE([JPEG output: $have_libjpeg])
diff --git a/libheif/Makefile.am b/libheif/Makefile.am
index 5fb33eb..a1bb5c7 100644
--- a/libheif/Makefile.am
+++ b/libheif/Makefile.am
@@ -21,12 +21,12 @@ if HAVE_X265
 ADDITIONAL_LIBS += $(x265_LIBS)
 endif
 
-if ENABLE_LOCAL_RAV1E
-ADDITIONAL_LIBS += ../third-party/rav1e/target/release/librav1e.a -ldl
+if HAVE_RAV1E
+ADDITIONAL_LIBS += $(rav1e_LIBS)
 endif
 
-if ENABLE_LOCAL_DAV1D
-ADDITIONAL_LIBS += ../third-party/dav1d/build/src/libdav1d.a -ldl
+if HAVE_DAV1D
+ADDITIONAL_LIBS += $(dav1d_LIBS)
 endif
 
 libheif_la_CPPFLAGS =
@@ -38,17 +38,10 @@ libheif_la_CXXFLAGS = \
   $(aom_CFLAGS) \
   $(libde265_CFLAGS) \
   $(x265_CFLAGS) \
+  $(dav1d_CFLAGS) \
   -DLIBHEIF_EXPORTS -I$(top_srcdir)
 libheif_la_LIBADD = $(ADDITIONAL_LIBS)
 
-if ENABLE_LOCAL_RAV1E
-libheif_la_CXXFLAGS += -I../third-party/rav1e/target/release/include
-endif
-
-if ENABLE_LOCAL_DAV1D
-libheif_la_CXXFLAGS += -I../third-party/dav1d/build -I../third-party/dav1d/build/include -I../third-party/dav1d/build/include/dav1d -I../third-party/dav1d/include
-endif
-
 libheif_la_LDFLAGS = -version-info $(LIBHEIF_CURRENT):$(LIBHEIF_REVISION):$(LIBHEIF_AGE)
 if MINGW
 libheif_la_LDFLAGS += -no-undefined
@@ -99,13 +92,13 @@ libheif_la_SOURCES += \
   heif_decoder_libde265.h
 endif
 
-if ENABLE_LOCAL_RAV1E
+if HAVE_RAV1E
 libheif_la_SOURCES += \
   heif_encoder_rav1e.cc \
   heif_encoder_rav1e.h
 endif
 
-if ENABLE_LOCAL_DAV1D
+if HAVE_DAV1D
 libheif_la_SOURCES += \
   heif_decoder_dav1d.cc \
   heif_decoder_dav1d.h
diff --git a/libheif/heif_encoder_rav1e.cc b/libheif/heif_encoder_rav1e.cc
index a429633..71e7278 100644
--- a/libheif/heif_encoder_rav1e.cc
+++ b/libheif/heif_encoder_rav1e.cc
@@ -34,7 +34,7 @@
 
 #include <iostream>  // TODO: remove me
 
-#include "rav1e/rav1e.h"
+#include <rav1e/rav1e.h>
 
 
 struct encoder_struct_rav1e
-- 
2.28.0

